x-logging: &default-logging
  driver: "json-file"
  options:
    max-size: "100mb"
    max-file: "3"

services:
  db:
    image: postgres:17
    container_name: litellm-db
    logging: *default-logging
    restart: always
    env_file:
      - ../../.env
    volumes:
      - ../../data/postgres:/var/lib/postgresql/data
      - ../../scripts/init-db.sql:/docker-entrypoint-initdb.d/init-db.sql
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -d litellm -U llmproxy"]
      interval: 1s
      timeout: 5s
      retries: 10
    networks:
      - ai-gateway-connect

  redis:
    image: redis:7-alpine
    container_name: litellm-redis
    logging: *default-logging
    restart: always
    volumes:
      - ../../data/redis:/data
    command: redis-server --appendonly yes
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - ai-gateway-connect

  clickhouse:
    image: docker.io/clickhouse/clickhouse-server
    container_name: langfuse-clickhouse
    logging: *default-logging
    restart: always
    user: "101:101"
    environment:
      CLICKHOUSE_DB: default
      CLICKHOUSE_USER: ${CLICKHOUSE_USER:-clickhouse}
      CLICKHOUSE_PASSWORD: ${CLICKHOUSE_PASSWORD:-clickhouse}
    volumes:
      - ../../data/clickhouse/data:/var/lib/clickhouse
      - ../../data/clickhouse/logs:/var/log/clickhouse-server
    healthcheck:
      test: wget --no-verbose --tries=1 --spider http://localhost:8123/ping || exit 1
      interval: 5s
      timeout: 5s
      retries: 10
      start_period: 1s
    networks:
      - ai-gateway-connect

  minio:
    image: cgr.dev/chainguard/minio
    container_name: langfuse-minio
    logging: *default-logging
    restart: always
    entrypoint: sh
    command: -c 'mkdir -p /data/langfuse && minio server --address ":9000" --console-address ":9001" /data'
    environment:
      MINIO_ROOT_USER: ${MINIO_ROOT_USER:-minio}
      MINIO_ROOT_PASSWORD: ${MINIO_ROOT_PASSWORD:-miniosecret}
    volumes:
      - ../../data/minio:/data
    healthcheck:
      test: ["CMD", "mc", "ready", "local"]
      interval: 1s
      timeout: 5s
      retries: 5
      start_period: 1s
    networks:
      - ai-gateway-connect

networks:
  ai-gateway-connect:
    external: true
