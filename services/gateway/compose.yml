x-logging: &default-logging
  driver: "json-file"
  options:
    max-size: "100mb"
    max-file: "3"

services:
  cli-proxy-api:
    image: eceasy/cli-proxy-api:latest
    container_name: cli-proxy-api
    logging: *default-logging
    ports:
      - 8317:8317
    restart: always
    env_file:
      - ../../.env
    environment:
      PROXY_API_KEY: ${CLIPROXYAPI_KEY:-sk-dummy}
    volumes:
      - ../../data/cliproxyapi/auth-dir:/root/.cli-proxy-api
      - ../../config/cliproxyapi/config.yaml:/CLIProxyAPI/config.yaml
    develop:
      watch:
        - action: sync+restart
          path: ../../config/cliproxyapi/config.yaml
          target: /CLIProxyAPI/config.yaml
    networks:
      - ai-gateway-connect

  litellm:
    image: docker.litellm.ai/berriai/litellm:main-stable
    container_name: litellm_proxy
    logging: *default-logging
    ports:
      - "4000:4000"
    restart: always
    volumes:
      - ../../config/litellm/config.yaml:/app/config.yaml
    command: ["--config", "/app/config.yaml", "--detailed_debug"]
    init: true
    environment:
      CLIPROXYAPI_BASE_URL: "http://cli-proxy-api:8317"
      CLIPROXYAPI_OPENAI_BASE_URL: "http://cli-proxy-api:8317/v1"
      CLIPROXYAPI_GEMINI_BASE_URL: "http://cli-proxy-api:8317/v1beta"
    env_file:
      - ../../.env
    depends_on:
      - db
    healthcheck:
      test:
        - CMD-SHELL
        - python3 -c "import urllib.request; urllib.request.urlopen('http://localhost:4000/health/liveliness')"
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    develop:
      watch:
        - action: sync+restart
          path: ../../config/litellm/config.yaml
          target: /app/config.yaml
    networks:
      - ai-gateway-connect
